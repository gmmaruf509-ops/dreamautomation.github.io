<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard ‚Äì Dream Automation</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: radial-gradient(circle at top, #3a4bff 0, #050018 55%, #02000b 100%);
      color: #f9fafb;
      min-height: 100vh;
    }

    a {
      color: inherit;
      text-decoration: none;
    }

    .app-shell {
      display: flex;
      min-height: 100vh;
    }

    /* ===== sidebar ===== */

    .sidebar {
      width: 220px;
      background: rgba(3, 7, 18, 0.95);
      border-right: 1px solid rgba(148, 163, 184, 0.15);
      padding: 18px 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
    }

    .brand-logo {
      width: 32px;
      height: 32px;
      border-radius: 10px;
      background: linear-gradient(135deg, #22c55e, #0ea5e9);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 18px;
    }

    .brand-text {
      font-size: 15px;
      font-weight: 600;
    }

    .nav-section-title {
      font-size: 11px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: rgba(148, 163, 184, 0.9);
      margin: 6px 0 4px;
    }

    .nav-list {
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .nav-item > a {
      display: block;
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 13px;
      color: rgba(226, 232, 240, 0.9);
    }

    .nav-item.active > a {
      background: linear-gradient(90deg, #22c55e, #0ea5e9);
      color: #020617;
      font-weight: 600;
    }

    .nav-item > a:hover {
      background: rgba(15, 23, 42, 0.9);
    }

    .sidebar-footer {
      margin-top: auto;
      font-size: 11px;
      color: rgba(148, 163, 184, 0.7);
    }

    /* ===== main ===== */

    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .topbar {
      height: 56px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 26px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.15);
      background: radial-gradient(circle at top left, #1f2937 0, #020617 55%);
      backdrop-filter: blur(18px);
    }

    .topbar-left {
      font-size: 13px;
      color: rgba(148, 163, 184, 0.9);
    }

    .topbar-left span {
      color: #e5e7eb;
      font-weight: 600;
    }

    .topbar-right {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 13px;
    }

    .pill {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.35);
      color: rgba(226, 232, 240, 0.9);
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 6px 16px;
      font-size: 13px;
      cursor: pointer;
      background: #0f172a;
      color: #e5e7eb;
      border: 1px solid rgba(148, 163, 184, 0.6);
    }

    .btn:hover {
      background: rgba(15, 23, 42, 0.9);
    }

    .btn-primary {
      background: linear-gradient(90deg, #22c55e, #0ea5e9);
      color: #020617;
      border-color: transparent;
      font-weight: 600;
    }

    .btn-primary:hover {
      filter: brightness(1.05);
    }

    .btn-wide {
      width: 100%;
      justify-content: center;
      text-align: center;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: default;
    }

    /* ===== content ===== */

    .content {
      flex: 1;
      padding: 24px 26px 30px;
      display: flex;
      flex-direction: column;
      gap: 22px;
    }

    h1 {
      font-size: 26px;
      font-weight: 700;
      margin-bottom: 2px;
    }

    .subtitle {
      font-size: 13px;
      color: rgba(148, 163, 184, 0.9);
    }

    .grid-two {
      display: grid;
      grid-template-columns: 2.1fr 1.2fr;
      gap: 18px;
      align-items: flex-start;
    }

    .card {
      border-radius: 18px;
      background: radial-gradient(circle at top left,
          rgba(30, 64, 175, 0.45),
          rgba(15, 23, 42, 0.98));
      padding: 18px 20px 18px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.85);
    }

    .card h3 {
      font-size: 15px;
      margin-bottom: 10px;
    }

    .muted {
      font-size: 12px;
      color: rgba(148, 163, 184, 0.9);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 11px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.55);
      color: #e5e7eb;
      gap: 6px;
    }

    .badge-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
    }

    .account-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      gap: 10px;
    }

    .account-meta {
      font-size: 12px;
      color: rgba(148, 163, 184, 0.9);
    }

    .account-meta p + p {
      margin-top: 4px;
    }

    .trial-bar {
      margin-top: 10px;
      border-radius: 999px;
      padding: 10px 14px;
      text-align: center;
      font-size: 13px;
      font-weight: 500;
      background: linear-gradient(90deg, #22c55e, #0ea5e9);
      color: #020617;
    }

    .trial-bar span {
      font-weight: 600;
    }

    .trial-actions {
      margin-top: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .trial-status-text {
      font-size: 12px;
      color: rgba(148, 163, 184, 0.95);
    }

    /* ===== Trial Key ‚Äì ‡¶¨‡ßú ‡¶≤‡ßá‡¶ñ‡¶æ ===== */

    .trial-key-box {
      margin-top: 10px;
      padding: 14px 18px;
      border-radius: 12px;
      background: rgba(15, 23, 42, 0.85);
      border: 1px dashed rgba(148, 163, 184, 0.75);
      text-align: center;
    }

    .trial-key {
      font-family: "Fira Code", "Consolas", monospace;
      font-size: 22px !important; /* ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶∏‡¶æ‡¶á‡¶ú ‡¶¨‡ßú */
      letter-spacing: 0.10em;
      color: #ffffff;
      user-select: all;
      word-break: break-all;
    }

    .trial-key-label {
      font-weight: 700;
      margin-right: 8px;
    }

    .trial-key-value {
      font-weight: 600;
    }

    /* ===== bottom ===== */

    .footer {
      margin-top: auto;
      font-size: 11px;
      text-align: center;
      color: rgba(148, 163, 184, 0.75);
      padding-top: 10px;
    }

    @media (max-width: 960px) {
      .app-shell {
        flex-direction: column;
      }
      .sidebar {
        width: 100%;
        flex-direction: row;
        align-items: center;
        overflow-x: auto;
      }
      .main {
        flex: 1;
      }
      .grid-two {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
  <div class="app-shell">
    <!-- ===== SIDEBAR ===== -->
    <aside class="sidebar">
      <div>
        <div class="brand">
          <div class="brand-logo">DA</div>
          <div class="brand-text">Dream Automation</div>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Main</div>
          <ul class="nav-list">
            <li class="nav-item active"><a href="#">Dashboard</a></li>
            <li class="nav-item"><a href="#">My Products</a></li>
            <li class="nav-item"><a href="#">Orders</a></li>
          </ul>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Account</div>
          <ul class="nav-list">
            <li class="nav-item"><a href="#">Account Settings</a></li>
            <li class="nav-item"><a href="#">Support Center</a></li>
          </ul>
        </div>
      </div>

      <div class="sidebar-footer">
        ¬© <span id="year"></span> Dream Automation
      </div>
    </aside>

    <!-- ===== MAIN ===== -->
    <main class="main">
      <!-- topbar -->
      <header class="topbar">
        <div class="topbar-left">
          Manage your licenses &amp; downloads
          <span> ¬∑ Dashboard</span>
        </div>
        <div class="topbar-right">
          <div class="pill">
            Welcome, <span id="nav-username">loading...</span>
          </div>
          <button class="btn" id="back-to-site-btn">Back to site</button>
          <button class="btn btn-primary" id="logout-btn">Log out</button>
        </div>
      </header>

      <!-- content -->
      <section class="content">
        <div>
          <h1>Welcome, <span id="dash-username">loading...</span></h1>
          <p class="subtitle">
            Manage your license, download the software and access all automation
            tools from a single dashboard.
          </p>
        </div>

        <div class="grid-two">
          <!-- LEFT: Product / downloads -->
          <article class="card">
            <h3>Your Product</h3>
            <p class="muted" style="margin-bottom: 10px;">
              Dream Automation ‚Äì all-in-one automation software for your business.
            </p>

            <div style="margin-top: 8px; margin-bottom: 8px;">
              <span class="badge">
                <span class="badge-dot"></span>
                AI-powered
              </span>
              <span class="badge" style="margin-left: 6px;">
                1-click workflows
              </span>
              <span class="badge" style="margin-left: 6px;">
                Lifetime updates (lifetime plan)
              </span>
            </div>

            <button class="btn btn-primary btn-wide" style="margin-top: 16px;">
              ‚Üì Download Software
            </button>

            <button class="btn btn-wide" style="margin-top: 10px;">
              üõí Buy Lifetime Access
            </button>
          </article>

          <!-- RIGHT: Account overview -->
          <article class="card">
            <div class="account-header">
              <h3>Account Overview</h3>
              <div class="badge" id="plan-badge">
                <span class="badge-dot"></span>
                <span id="badge-text">Free</span>
              </div>
            </div>

            <div class="account-meta">
              <p>
                <strong>Email:</strong>
                <span id="dash-email">loading...</span>
              </p>
              <p>
                <strong>Plan:</strong>
                <span id="plan-label">Free / Trial (loading)</span>
              </p>
              <p>
                <strong>Status:</strong>
                <span id="status-label">Loading...</span>
              </p>
            </div>

            <!-- Trial banner -->
            <div class="trial-bar" id="trial-bar">
              <span id="trial-bar-label">Free</span>
            </div>

            <!-- Trial controls -->
            <div class="trial-actions">
              <button
                class="btn btn-primary btn-wide"
                id="request-trial-btn">
                Request 2-Day Free Trial
              </button>

              <p class="trial-status-text" id="trial-status-text">
                Loading trial status...
              </p>
            </div>

            <!-- ‡¶¨‡ßú ‡¶ï‡¶∞‡ßá key ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø -->
            <div
              class="trial-key-box"
              id="trial-key-box"
              style="display: none">
              <div class="trial-key">
                <span class="trial-key-label">Your Key = </span>
                <span
                  class="trial-key-value"
                  id="trial-key-text">
                  00000000-0000-0000-0000-000000000000
                </span>
              </div>
            </div>
          </article>
        </div>

        <div class="footer">
          Need help? Contact us any time ‚Äî your success with Dream Automation is
          our top priority.
        </div>
      </section>
    </main>
  </div>

  <!-- ===== Firebase + Trial logic ===== -->
  <script type="module">
    // footer year
    const yearEl = document.getElementById("year");
    if (yearEl) yearEl.textContent = new Date().getFullYear();

    const backBtn = document.getElementById("back-to-site-btn");
    if (backBtn) {
      backBtn.addEventListener("click", () => {
        window.location.href = "index.html";
      });
    }

    // ===== Apps Script bridge URL =====
    const BRIDGE_API_URL =
      "https://script.google.com/macros/s/AKfycbwUMn-tpNUlbaOoYQLA_7RRS_geJ-Vl0z1gLs8goCMB62yyXaTeJr4xKU3SRZGnoIMK/exec";

    async function callTrialApi(action, email) {
      const res = await fetch(BRIDGE_API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ action, email }),
      });
      return await res.json();
    }

    // ===== Firebase imports =====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut,
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

    // ===== Firebase config (‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡¶ú‡ßá‡¶ï‡ßç‡¶ü) =====
    const firebaseConfig = {
      apiKey: "AIzaSyA_lZmfn4T31B6jm1dB0UywR7OEgYIPlo0",
      authDomain: "sceneflow-studio.firebaseapp.com",
      projectId: "sceneflow-studio",
      storageBucket: "sceneflow-studio.firebasestorage.app",
      messagingSenderId: "961327164320",
      appId: "1:961327164320:web:7ffb160db2529f4c1412c5",
      measurementId: "G-56962H6FQ4",
    };

    const app = initializeApp(firebaseConfig);
    getAnalytics(app);
    const auth = getAuth(app);

    // ===== DOM refs =====
    const navUsername = document.getElementById("nav-username");
    const dashUsername = document.getElementById("dash-username");
    const dashEmail = document.getElementById("dash-email");
    const planLabel = document.getElementById("plan-label");
    const statusLabel = document.getElementById("status-label");
    const badgeText = document.getElementById("badge-text");
    const trialBar = document.getElementById("trial-bar");
    const trialBarLabel = document.getElementById("trial-bar-label");
    const trialBtn = document.getElementById("request-trial-btn");
    const trialStatusText = document.getElementById("trial-status-text");
    const trialKeyBox = document.getElementById("trial-key-box");
    const trialKeyText = document.getElementById("trial-key-text");
    const logoutBtn = document.getElementById("logout-btn");

    // ===== date helper: ‡¶¶‡¶ø‡¶® ‡¶Æ‡¶æ‡¶∏ ‡¶¨‡¶õ‡¶∞ =====
    function formatDateDMY(isoString) {
      const d = new Date(isoString);
      if (isNaN(d.getTime())) return isoString;
      const months = [
        "Jan",
        "Feb",
        "Mar",
        "Apr",
        "May",
        "Jun",
        "Jul",
        "Aug",
        "Sep",
        "Oct",
        "Nov",
        "Dec",
      ];
      const day = d.getUTCDate();
      const month = months[d.getUTCMonth()];
      const year = d.getUTCFullYear();
      return `${day} ${month} ${year}`;
    }

    // ===== trial status load =====
    async function loadTrialStatus(email) {
      trialStatusText.textContent = "Loading trial status...";
      trialKeyBox.style.display = "none";

      try {
        const data = await callTrialApi("trial_status", email);

        if (data.status !== "ok") {
          throw new Error(data.message || "Unknown error");
        }

        // mode: ‡¶Ü‡¶Æ‡¶∞‡¶æ Code.gs ‡¶è ‡¶Ø‡ßá‡¶Æ‡¶® ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßá‡¶õ‡¶ø ‚Äì ‡¶â‡¶¶‡¶æ‡¶π‡¶∞‡¶£:
        // "none", "trial_active", "trial_expired", "paid"
        const mode = data.mode || "none";

        if (mode === "none") {
          planLabel.textContent = "Free / Trial (not requested)";
          statusLabel.textContent = "Free";
          badgeText.textContent = "Free";
          trialBarLabel.textContent = "Free";
          trialBar.textContent = "Free plan ‚Äì you haven't used your trial yet.";
          trialBtn.style.display = "inline-flex";
          trialBtn.disabled = false;
          trialBtn.textContent = "Request 2-Day Free Trial";
          trialStatusText.textContent =
            "You can request a 2-day free trial. Click the button above.";
        } else if (mode === "trial_active") {
          planLabel.textContent = "Trial (active)";
          statusLabel.textContent = "Active";
          badgeText.textContent = "Trial";
          trialBarLabel.textContent = "Trial active";

          const niceDate = formatDateDMY(data.expiry);
          trialBar.textContent = `Trial active ¬∑ Expires on ${niceDate}`;
          trialBtn.style.display = "none";

          trialStatusText.textContent =
            "Your 2-day trial is active. Use the key below inside the software.";
          trialKeyText.textContent = data.license_key || "";
          trialKeyBox.style.display = "block";
        } else if (mode === "trial_expired") {
          planLabel.textContent = "Trial (expired)";
          statusLabel.textContent = "Expired";
          badgeText.textContent = "Trial expired";
          trialBarLabel.textContent = "Trial expired";

          const niceDate = formatDateDMY(data.expiry);
          trialBar.textContent = `Your trial expired on ${niceDate}`;
          trialBtn.style.display = "none";
          trialKeyBox.style.display = "none";
          trialStatusText.textContent =
            "Your trial has ended. Please purchase a license to continue.";
        } else if (mode === "paid") {
          planLabel.textContent = "Paid";
          statusLabel.textContent = "Active";
          badgeText.textContent = "Lifetime";
          trialBarLabel.textContent = "Lifetime license";
          trialBar.textContent =
            "You have an active paid license. Enjoy all features without limits.";
          trialBtn.style.display = "none";
          trialKeyBox.style.display = "none";
          trialStatusText.textContent = "";
        } else {
          throw new Error("Unknown mode");
        }
      } catch (err) {
        console.error(err);
        trialBarLabel.textContent = "Error";
        trialBar.textContent = "Error loading trial status.";
        trialStatusText.textContent =
          "Could not load trial status. Please try again later.";
        badgeText.textContent = "Free";
        trialBtn.style.display = "inline-flex";
      }
    }

    // ===== main auth handler =====
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "index.html";
        return;
      }

      const email = user.email || "";
      const name =
        user.displayName || (email ? email.split("@")[0] : "User");

      if (navUsername) navUsername.textContent = name;
      if (dashUsername) dashUsername.textContent = name;
      if (dashEmail) dashEmail.textContent = email;

      await loadTrialStatus(email);

      if (trialBtn) {
        trialBtn.addEventListener("click", async () => {
          trialBtn.disabled = true;
          trialBtn.textContent = "Requesting...";
          try {
            const data = await callTrialApi("trial_create", email);
            if (data.status === "ok") {
              alert("Trial created! Your key is now visible.");
              await loadTrialStatus(email);
            } else {
              alert(data.message || "Could not create trial.");
            }
          } catch (e) {
            console.error(e);
            alert("Network error while requesting trial.");
          } finally {
            trialBtn.disabled = false;
          }
        });
      }

      if (logoutBtn) {
        logoutBtn.addEventListener("click", async () => {
          await signOut(auth);
          window.location.href = "index.html";
        });
      }
    });
  </script>
</body>
</html>
